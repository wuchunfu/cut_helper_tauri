# 配置功能验证说明

## ✅ 已修复的问题

### 问题描述
之前配置虽然可以保存，但没有真正应用到业务逻辑中，仍然使用代码中写死的数量限制。

### 解决方案

1. **确保配置在使用前加载完成**
   ```javascript
   async init() {
     if (!db) {
       db = await Database.load('sqlite:cut.db');
     }
     // 确保配置已加载
     if (!configLoaded) {
       await loadConfig();
     }
   }
   ```

2. **配置真正应用到业务逻辑**
   - 文本记录：`if (totalCount > config.max_text_history)`
   - 图片记录：`if (totalCount > config.max_image_history)`

3. **保存后立即生效**
   ```javascript
   // 保存配置后立即重新加载
   await db_service.reloadConfig();
   ```

## 🧪 如何验证配置是否生效

### 测试步骤1：验证文本历史限制

1. **打开设置窗口**
   - 右键点击托盘图标
   - 选择"设置"

2. **修改文本历史最大条数**
   - 将"文本历史记录最大条数"改为 **10**
   - 点击"保存设置"
   - 看到提示"配置保存成功并已生效"

3. **测试限制是否生效**
   - 复制15段不同的文本到剪贴板
   - 查看文本历史记录
   - **预期结果**：只保留最新的10条记录，旧的被自动删除

4. **控制台验证**
   - 打开浏览器开发者工具（F12）
   - 查看控制台输出
   - 应该看到：`配置已加载: {max_text_history: 10, max_image_history: 30}`

### 测试步骤2：验证图片历史限制

1. **修改图片历史最大数量**
   - 打开设置窗口
   - 将"图片历史最大数量"改为 **5**
   - 点击"保存设置"

2. **测试限制是否生效**
   - 复制10张不同的图片到剪贴板
   - 查看图片历史记录
   - **预期结果**：只保留最新的5张图片，旧的被自动删除

### 测试步骤3：验证配置持久化

1. **设置配置**
   - 文本历史：50条
   - 图片历史：20条
   - 保存设置

2. **关闭应用**
   - 完全退出应用程序

3. **重新启动应用**
   - 启动应用
   - 查看控制台输出
   - **预期结果**：看到 `配置已加载: {max_text_history: 50, max_image_history: 20}`

4. **验证配置生效**
   - 复制多段文本/图片
   - 验证是否按新配置的数量限制

## 📊 配置生效流程

```
用户修改配置
    ↓
点击保存
    ↓
invoke('save_config') → 保存到 config.json
    ↓
db_service.reloadConfig() → 立即重新加载配置
    ↓
emit('config-updated') → 发送事件通知
    ↓
配置应用到业务逻辑
    ↓
下次添加记录时使用新的限制数量
```

## 🔍 调试信息

### 查看当前配置
在浏览器控制台中执行：
```javascript
// 导入 db_service
import db_service from './db_service';

// 查看当前配置
console.log(db_service.getCurrentConfig());
```

### 查看配置文件
配置文件位置：
- **Windows**: `C:\Users\{用户}\AppData\Roaming\剪切板助手\config.json`
- **macOS**: `~/Library/Application Support/剪切板助手/config.json`
- **Linux**: `~/.config/剪切板助手/config.json`

内容示例：
```json
{
  "max_text_history": 50,
  "max_image_history": 20
}
```

### 控制台日志
应用运行时会输出以下日志：

1. **启动时**：
   ```
   配置已加载: {max_text_history: 500, max_image_history: 30}
   ```

2. **保存配置时**：
   ```
   配置已更新: {max_text_history: 50, max_image_history: 20}
   ```

3. **添加记录时**（如果触发清理）：
   ```
   当前记录数: 55, 配置限制: 50, 删除: 5条
   ```

## ✨ 配置功能特性

### 1. 实时生效
- ✅ 保存后立即重新加载配置
- ✅ 无需重启应用
- ✅ 下次操作立即使用新配置

### 2. 持久化存储
- ✅ 保存到 JSON 文件
- ✅ 应用重启后自动加载
- ✅ 容错处理，加载失败使用默认值

### 3. 自动清理
- ✅ 添加新记录时自动检查数量
- ✅ 超过限制自动删除最旧的记录
- ✅ 保持记录数量在配置的范围内

### 4. 多窗口同步
- ✅ 设置窗口保存后发送事件
- ✅ 主窗口监听事件并更新
- ✅ 所有功能使用同一配置

## 🎯 验证清单

- [ ] 修改文本历史限制，添加超过限制的文本，验证自动清理
- [ ] 修改图片历史限制，添加超过限制的图片，验证自动清理
- [ ] 保存配置，关闭应用，重启后验证配置被保存
- [ ] 查看控制台，确认配置加载和更新的日志
- [ ] 查看配置文件，确认配置被正确保存

## 📝 注意事项

1. **配置范围**
   - 文本历史：10-10000 条
   - 图片历史：5-1000 条
   - 超出范围会被限制在有效范围内

2. **清理时机**
   - 配置立即生效
   - 但只在添加新记录时触发清理
   - 不会主动清理现有超出的记录

3. **默认配置**
   - 首次启动：文本500条，图片30条
   - 配置文件损坏：自动使用默认值
   - 配置加载失败：使用默认值并记录日志

---

**验证完成时间**: 2025年10月14日  
**配置功能状态**: ✅ 完全可用  
**测试建议**: 按照上述步骤逐一验证

